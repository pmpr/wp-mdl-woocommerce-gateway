<?php
/*   _______________________________________
    |  Obfuscated by PMPR - Php Obfuscator  |
    |             6952c8cf4ddeb             |
    |_______________________________________|
*/
 namespace Pmpr\Module\WoocommerceGateway; use Pmpr\Common\Foundation\Interfaces\Constants; use Pmpr\Common\Foundation\Interfaces\IconInterface; use WP_Error; class Saderat extends Gateway { const ooqyemcucawmqiei = 'private_key'; const ukasscyqsciowiuk = 'terminal_id'; const sqcgiwscwqseqcgg = 'merchant_id'; protected $keyResource = false; protected ?string $privateKey = null; protected ?string $terminalID = null; protected ?string $merchantID = null; public function gamwaomqaoccigaw() : ?string { return $this->terminalID; } public function siuaeeoswquuwqie() : ?string { return $this->merchantID; } public function __construct() { $this->method_title = sprintf(__('%s Gateway', PR__MDL__WOOCOMMERCE_GATEWAY), __('Saderat Bank', PR__MDL__WOOCOMMERCE_GATEWAY)); parent::__construct(); } protected function qiccuiwooiquycsg() { $this->terminalID = $this->get_option(self::ukasscyqsciowiuk); $this->merchantID = $this->get_option(self::sqcgiwscwqseqcgg); if (extension_loaded('openssl')) { $this->privateKey = $this->iuygowkemiiwqmiw('private_key.txt', [self::ooqyemcucawmqiei => trim(get_option(self::ooqyemcucawmqiei))]); $gwawemusecawiuig = $this->iuygowkemiiwqmiw('public_key.txt'); $this->keyResource = openssl_get_publickey($gwawemusecawiuig); } } private function gmomauomeocqmegi(array $ywmkwiwkosakssii = []) { $icswuaiqeooqqeqc = implode(',', $ywmkwiwkosakssii); $eqwkauqaiykqwyck = ''; if (extension_loaded('openssl')) { $omawaymcsqmwaqoc = openssl_pkey_get_private($this->privateKey); if (!openssl_sign($icswuaiqeooqqeqc, $eqwkauqaiykqwyck, $omawaymcsqmwaqoc, OPENSSL_ALGO_SHA1)) { $eqwkauqaiykqwyck = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis('OPEN SSL SIGN ERROR'); } } return $eqwkauqaiykqwyck; } protected function aqmwamyiwgeeymqa($umwqusowiqmyseom) { $qcakkkwickkwyuck = $this->ewekkueqocsemugs('https://mabna.shaparak.ir/TokenService?wsdl', 'wsdl'); if ($qcakkkwickkwyuck) { $gkyciwoiiisgywcs = $this->caokeucsksukesyo()->ywqgcuymeiswqyqc(); $smowyuyseuwiaiei = $this->imuokicsysisyuge('IRR'); $qookweymeqawmcwo = $this->miywwkceumyiacom([ 'CRN' => date('ymdHis'), 'TID' => $this->gamwaomqaoccigaw(), 'AMOUNT' => $smowyuyseuwiaiei, 'REFERALADRESS' => $this->imkwoeqamegcwwoi(), ]); $eqwkauqaiykqwyck = $this->gmomauomeocqmegi($qookweymeqawmcwo); $qookweymeqawmcwo['SIGNATURE'] = base64_encode($eqwkauqaiykqwyck); $sogksuscggsicmac = $qcakkkwickkwyuck->reservation(['Token_param' => $qookweymeqawmcwo]); $iueymcwwscwqkiyq = $gkyciwoiiisgywcs->qamwegcyimgcqksw($sogksuscggsicmac, Constants::syomkiqgogwyuiyw, '-1'); if ($iueymcwwscwqkiyq == 0) { $mgegoogckgsumooq = $gkyciwoiiisgywcs->get($sogksuscggsicmac, Constants::sygmkaeayiiouiwm, ''); $sogksuscggsicmac = $this->oiqgeywasekgkssg($mgegoogckgsumooq, $sogksuscggsicmac['signature']); if ($sogksuscggsicmac && !is_wp_error($sogksuscggsicmac)) { $ycyucwoysmwkgiui = wpautop(wptexturize($this->sagusgigmkeysock(Constants::ukaqkkkyywmiuoac))); if ($ycyucwoysmwkgiui) { $this->uwkmaywceaaaigwo()->wikusamwomuogoau()->yiggueaiwiygoiyi($ycyucwoysmwkgiui); } echo $this->iuygowkemiiwqmiw(Constants::yquayuasseumiiii, [Constants::sygmkaeayiiouiwm => $mgegoogckgsumooq, Constants::uqgcmmosieyimiku => 'https://mabna.shaparak.ir']); } } else { $sogksuscggsicmac = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis(wpautop(wptexturize($this->sagusgigmkeysock(self::mqcksmagsgegwsks) . '<br/>خطا: ' . $this->ueeagokqmgisgauy($iueymcwwscwqkiyq)))); } } else { $sogksuscggsicmac = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis(__('Can not load Soap Client', PR__MDL__WOOCOMMERCE_GATEWAY)); } return $sogksuscggsicmac; } protected function ussowkigumoaoowo($umwqusowiqmyseom) : array { $eiicaiwgqkgsekce = $this->caokeucsksukesyo()->giiecckwoyiawoyy(); $iswcokucwmiosiaq = ''; $uamcoiueqaamsqma = ''; $cumkimmakqwyueag = $eiicaiwgqkgsekce->yyqgamuwwakgciey('CRN'); $ukoikcoywmwowwum = $eiicaiwgqkgsekce->yyqgamuwwakgciey('TRN'); if ($cumkimmakqwyueag && $ukoikcoywmwowwum) { $qcakkkwickkwyuck = $this->ewekkueqocsemugs('https://mabna.shaparak.ir/TransactionReference/TransactionReference?wsdl', 'wsdl'); if ($qcakkkwickkwyuck) { $qookweymeqawmcwo = $this->miywwkceumyiacom(['CRN' => $cumkimmakqwyueag, 'TRN' => $ukoikcoywmwowwum]); $eqwkauqaiykqwyck = $this->gmomauomeocqmegi($qookweymeqawmcwo); $qookweymeqawmcwo['SIGNATURE'] = base64_encode($eqwkauqaiykqwyck); $sogksuscggsicmac = $qcakkkwickkwyuck->sendConfirmation(['SaleConf_req' => $qookweymeqawmcwo]); $gkyciwoiiisgywcs = $this->caokeucsksukesyo()->ywqgcuymeiswqyqc(); $aycegyeagyyeyaqm = $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'RESCODE'); $icimsyceeegakcaw = $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'successful'); if ($aycegyeagyyeyaqm == '00' && $icimsyceeegakcaw) { $icwicymcioeyeyek = $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'RESCODE', '') . $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'REPETETIVE', '') . $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'AMOUNT', '') . $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'DATE', '') . $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'TIME', '') . $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'TRN', '') . $gkyciwoiiisgywcs->get($sogksuscggsicmac, 'STAN', ''); $oiqgeywasekgkssg = $this->oiqgeywasekgkssg($icwicymcioeyeyek, $sogksuscggsicmac['SIGNATURE']); if ($oiqgeywasekgkssg && !is_wp_error($sogksuscggsicmac)) { $iueymcwwscwqkiyq = Constants::amcogigwsaqssuai; $uamcoiueqaamsqma = sprintf("%s: %s", __('Transaction request number', PR__MDL__WOOCOMMERCE_GATEWAY), $ukoikcoywmwowwum); } else { $iueymcwwscwqkiyq = self::sockwoyeosqcegek; $uamcoiueqaamsqma = $this->caokeucsksukesyo()->euekiyuksecoccus()->skauuuoqcaiseuks($oiqgeywasekgkssg); } } else { $iueymcwwscwqkiyq = self::sockwoyeosqcegek; $uamcoiueqaamsqma = $this->ueeagokqmgisgauy($aycegyeagyyeyaqm); } } else { $iueymcwwscwqkiyq = self::sockwoyeosqcegek; } } else { $iueymcwwscwqkiyq = Constants::uasuowkaguiwoouw; } return [Constants::uiwqcumqkgikqyue => [self::oyqcukwqaucsgiem => $ukoikcoywmwowwum], Constants::imkacwmiuiykyuim => $iswcokucwmiosiaq, Constants::ciywsqoeiymemsys => $iueymcwwscwqkiyq, Constants::eoskkkieowogacws => $uamcoiueqaamsqma, self::oyqcukwqaucsgiem => $ukoikcoywmwowwum]; } protected function qyeykswoowmwqmai() { $uuyucgkyusckoaeq = $this->caokeucsksukesyo()->wmkogisswkckmeua(); $this->kwkugmqouisgkqig($uuyucgkyusckoaeq->ycgeeoiieoiakgam('account_config')->saemoowcasogykak(IconInterface::iwayyimcuywiagyy)->gswweykyogmsyawy(__('Bank Account Configuration', PR__MDL__WOOCOMMERCE_GATEWAY))->mkksewyosgeumwsa($uuyucgkyusckoaeq->ymuegqgyuagyucws(self::ukasscyqsciowiuk)->kqqqugemmqagucuq()->gswweykyogmsyawy(__('Terminal ID (TID)', PR__MDL__WOOCOMMERCE_GATEWAY)))->mkksewyosgeumwsa($uuyucgkyusckoaeq->ymuegqgyuagyucws(self::sqcgiwscwqseqcgg)->kqqqugemmqagucuq()->gswweykyogmsyawy(__('Merchant ID (MID)', PR__MDL__WOOCOMMERCE_GATEWAY)))->mkksewyosgeumwsa($uuyucgkyusckoaeq->uouyygwcgsmygaee(self::ooqyemcucawmqiei)->kqqqugemmqagucuq()->mkmssscwmeekwgqo()->gswweykyogmsyawy(__('Private Key', PR__MDL__WOOCOMMERCE_GATEWAY)))); } public function miywwkceumyiacom($eyagkkkqkwcuygso) : array { return $this->caokeucsksukesyo()->gyecsegqciqykomu()->ckscqqquyskscaaw($eyagkkkqkwcuygso, ['MID' => $this->siuaeeoswquuwqie()]); } private function oiqgeywasekgkssg($icwicymcioeyeyek, $eqwkauqaiykqwyck) { $oiqgeywasekgkssg = false; if (extension_loaded('openssl')) { $oiqgeywasekgkssg = openssl_verify($icwicymcioeyeyek, base64_decode($eqwkauqaiykqwyck), $this->keyResource); } if ($oiqgeywasekgkssg == 1) { $sogksuscggsicmac = true; } else { if ($oiqgeywasekgkssg == 0) { $sogksuscggsicmac = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis('خطا در ارسال درخواست به بانک'); } else { $sogksuscggsicmac = $this->caokeucsksukesyo()->euekiyuksecoccus()->gosmqcmmomkqwmis('عدم تطبیق امضا دیجیتال بانک'); } } return $sogksuscggsicmac; } private function ueeagokqmgisgauy($ymacoouqwcqwwagu) : ?string { switch ($ymacoouqwcqwwagu) { case '-1000': $uamcoiueqaamsqma = __('خطای ارتباط با بانک', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '-1': $uamcoiueqaamsqma = __('امضای دیچیتال نا معتبر است', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '-2': $uamcoiueqaamsqma = __('آدرس IP پذیرنده نامعتبر است', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '1': $uamcoiueqaamsqma = __('وجود خطا در فرمت اطلاعات ارسالی', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '2': $uamcoiueqaamsqma = __('عدم وجود پذیرنده و ترمینال مورد درخواست در سیستم', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '3': $uamcoiueqaamsqma = __('آدرس IP درخواست کننده  (پذیرنده) نامعتبر است', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '4': $uamcoiueqaamsqma = __('پذیرنده موردنظر امکان استفاده از سیستم را ندارد', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '5': $uamcoiueqaamsqma = __('خطا در زمان انجام درخواست', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '6': $uamcoiueqaamsqma = __('خطا در پردازش درخواست', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '7': $uamcoiueqaamsqma = __('امضا دیجیتال نا معتبر است', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '8': $uamcoiueqaamsqma = __('شماره خرید ارائه شده توسط پذیرنده  (Invoice Number) نامعتبر است', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '9': $uamcoiueqaamsqma = __('درگاه بانک در حال حاضر قادر به سرویس دهی نمی باشد', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '101': $uamcoiueqaamsqma = __('تراکنش مورد نظر قبلا تایید شده است', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '102': $uamcoiueqaamsqma = __('تراکنش مورد نظر برگشت خورده است', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '103': $uamcoiueqaamsqma = __('تایید انجام نشد.', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '106': $uamcoiueqaamsqma = __('پیامی از سویچی دریافت نشد', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '107': $uamcoiueqaamsqma = __('تراکنش درخواستی موجود نیست', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '111': $uamcoiueqaamsqma = __('مشکل در ارتباط با سوئیچ', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '112': $uamcoiueqaamsqma = __('An unknown error has occurred', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '113': $uamcoiueqaamsqma = __('مقادیر ارسالی در درخواست معتبر نیستند.', PR__MDL__WOOCOMMERCE_GATEWAY); break; case '200': $uamcoiueqaamsqma = __('تراکنش توسط کاربر کنسل شده است.', PR__MDL__WOOCOMMERCE_GATEWAY); break; default: $uamcoiueqaamsqma = __('خطای سمت سرور', PR__MDL__WOOCOMMERCE_GATEWAY); break; } return $uamcoiueqaamsqma; } }
