<?php
/*   _______________________________________
    |  Obfuscated by PMPR - Php Obfuscator  |
    |             680106a828239             |
    |_______________________________________|
*/
 function woocommerce_pasargad_payment_init() { if (!class_exists('WC_Payment_Gateway')) { return; } add_filter('plugin_action_links', array('WC_Pasargad_Gateway', 'pep_wpwc_plugin_action_links'), 10, 2); class WC_Pasargad_Gateway extends WC_Payment_Gateway { public function init_settings() { parent::init_settings(); } static $username_p = ''; static $password_p = ''; static $token_p = ''; static $my_return_url = ''; static $base_url = ''; public function __construct() { $this->id = 'pasargad'; $this->method_title = 'درگاه پرداخت الکترونیک پاسارگاد'; $this->method_description = 'این افزونه درگاه پرداخت الکترونیک پاسارگاد را به روش های پرداختی ووکامرس اضافه می کند'; $this->has_fields = false; $this->redirect_uri = WC()->api_request_url('WC_Pasargad_Gateway'); $this->icon = apply_filters('pasargad_logo', WP_PLUGIN_URL . '/' . plugin_basename(__DIR__) . '/images/logo.png'); $this->init_form_fields(); $this->init_settings(); $this->pasargad_terminal_id = self::oiicaeigckygieyy($this->settings['pasargad_terminal_id']); $this->pasargad_merchant_id = self::oiicaeigckygieyy($this->settings['pasargad_merchant_id']); $this->pasargad_username = $this->settings['pasargad_username']; $this->pasargad_password = $this->settings['pasargad_password']; self::$password_p = $this->pasargad_password; self::$username_p = $this->pasargad_username; $this->title = __($this->settings['title'], 'woocommerce'); $this->description = __($this->settings['description'], 'woocommerce'); $this->success_massage = __($this->settings['success_massage'], 'woocommerce'); $this->failed_massage = __($this->settings['failed_massage'], 'woocommerce'); $this->cancelled_massage = __($this->settings['cancelled_massage'], 'woocommerce'); $this->msg['message'] = ''; $this->msg['class'] = ''; self::$base_url = __($this->settings['base_url'], 'woocommerce'); $this->is_finish_order = $this->settings['is_finish_order']; if (isset($this->settings['orderstatus'])) { $this->orderstatus = $this->settings['orderstatus']; } else { $this->orderstatus = 1; } add_action('woocommerce_update_options_payment_gateways_' . $this->id, array($this, 'process_admin_options')); add_action('woocommerce_receipt_pasargad', array($this, 'receipt_page')); add_action('woocommerce_api_' . strtolower(get_class($this)) . '', array($this, 'ekiuyucoiagmscgy')); } public function init_form_fields() { $this->form_fields = array('enabled' => array('title' => 'فعال / غیرفعال :', 'type' => 'checkbox', 'label' => 'فعال یا غیرفعال سازی درگاه پرداخت الکترونیک پاسارگاد', 'default' => 'no'), 'pasargad_terminal_id' => array('title' => 'شماره ترمینال :', 'type' => 'text', 'required' => true, 'desc_tip' => true), 'pasargad_merchant_id' => array('title' => 'شماره فروشگاه :', 'type' => 'text', 'required' => true, 'desc_tip' => false), 'pasargad_username' => array('title' => 'نام کاربری :', 'type' => 'text', 'required' => true, 'desc_tip' => true), 'pasargad_password' => array('title' => 'کلمه عبور :', 'type' => 'password', 'required' => true, 'desc_tip' => true), 'title' => array('title' => 'عنوان درگاه :', 'type' => 'text', 'description' => 'این نام در طی فرایند خرید به مشتری نمایش داده می شود', 'default' => 'بانک پاسارگاد'), 'description' => array('title' => 'توضیحات درگاه', 'type' => 'textarea', 'description' => 'توضیحاتی که در طی عملیات پرداخت برای درگاه نمایش داده خواهد شد', 'default' => 'پرداخت امن به وسیله کلیه کارت های عضو شتاب از طریق بانک پاسارگاد'), 'success_massage' => array('title' => 'پیام پرداخت موفق', 'type' => 'textarea', 'description' => 'متن پیامی که میخواهید بعد از پرداخت موفق به کاربر نمایش دهید را وارد نمایید ، می توانید از شورت کد {transaction_id} نیز برای نمایش کد رهگیری تراکنش و از شرت کد {SaleOrderId} برای شماره درخواست استفاده نمایید .', 'default' => 'با تشکر از شما . سفارش شما با موفقیت پرداخت شد .'), 'failed_massage' => array('title' => 'پیام پرداخت ناموفق', 'type' => 'textarea', 'description' => 'متن پیامی که میخواهید بعد از پرداخت ناموفق به کاربر نمایش دهید را وارد نمایید ، می توانید از شورت کد {fault} نیز برای نمایش دلیل خطای رخ داده استفاده نمایید.', 'default' => 'پرداخت شما ناموفق بوده است . لطفا مجددا تلاش نمایید یا در صورت بروز اشکال با مدیر سایت تماس بگیرید .'), 'cancelled_massage' => array('title' => 'پیام انصراف از پرداخت', 'type' => 'textarea', 'description' => 'متن پیامی که میخواهید بعد از انصراف کاربر از پرداخت نمایش دهید را وارد نمایید . این پیام بعد از بازگشت از بانک نمایش داده خواهد شد .', 'default' => 'پرداخت به دلیل انصراف شما ناتمام باقی ماند .'), 'is_finish_order' => array('title' => 'پس از پرداخت سفارش به وضعیت تکمیل تغییر یابد. :', 'type' => 'checkbox', 'label' => 'اگر این گزینه انتخاب شود پس از پرداخت، سفارش به وضعیت <b>"تکمیل سفارش"</b> تغییر می یابد، در غیر اینصورت به وضعیت <b>"در حال آماده سازی"</b> تغییر می یابد.', 'default' => 'no'), 'base_url' => array('title' => 'آدرس پایه:', 'type' => 'text', 'label' => 'لطفا آدرس پایه را از شرکت پرداخت الکترونیک پاسارگاد دریافت کنید:', 'default' => 'https://pep.shaparak.ir/pepg')); } public function admin_options() { echo '<h3>تنظیمات درگاه پرداخت الکترونیک پاسارگاد :</h3>'; echo '<table class="form-table">'; $this->generate_settings_html(); echo '</table>'; } public static function qaiewqumaqycgomm($sgmiwyygoukwoymc, $wicckmmecawymiys, $wyauwiokiskgakek, $miieuicskiokicke, $amsewiqkasicuaws, $yeysogmaguosowak = '', $miqcusmcqyeqegme = '') { $ceaqswckgymsswqk = self::$username_p; $wmsqwokmgiusoswc = self::$password_p; $icwicymcioeyeyek = array('username' => $ceaqswckgymsswqk, 'password' => $wmsqwokmgiusoswc); self::$token_p = self::swieyekscicyigcg()->token; $sogksuscggsicmac = ""; if (isset(self::$token_p)) { $eowgaqeqiwqauugi = curl_init(); $ocogsiouoiuuguym = new DateTime(); $icuyogeyaokmwusi = $ocogsiouoiuuguym->format('Y-m-d H:i:s'); curl_setopt_array($eowgaqeqiwqauugi, array(CURLOPT_URL => self::$base_url . '/api/payment/purchase', CURLOPT_RETURNTRANSFER => true, CURLOPT_ENCODING => '', CURLOPT_MAXREDIRS => 10, CURLOPT_TIMEOUT => 0, CURLOPT_FOLLOWLOCATION => true, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1, CURLOPT_CUSTOMREQUEST => 'POST', CURLOPT_POSTFIELDS => '{
                "amount":' . strval($miieuicskiokicke) . ',
                "callbackApi": "' . $amsewiqkasicuaws . '",
                "description":"",
                "invoice": "' . strval($sgmiwyygoukwoymc) . '",
                "invoiceDate":"' . $icuyogeyaokmwusi . '",
                "mobileNumber":"",
                "serviceCode": "8",
                "serviceType": "PURCHASE",
                "payerMail": "",
                "payerName": "",
                "terminalNumber":"' . self::oiicaeigckygieyy($wicckmmecawymiys) . '",
                "nationalCode": "",
                "paymentCode":"0"
                }', CURLOPT_HTTPHEADER => array('Authorization: Bearer ' . self::$token_p, 'Content-Type: application/json'))); $keccaugmemegoimu = curl_exec($eowgaqeqiwqauugi); $sogksuscggsicmac = json_decode($keccaugmemegoimu); curl_close($eowgaqeqiwqauugi); if (isset($keccaugmemegoimu) && isset($sogksuscggsicmac->resultCode)) { if ($sogksuscggsicmac->resultCode == 0) { self::d_redirect($sogksuscggsicmac->data->url); } else { self::display_error($sogksuscggsicmac->resultCode, '', strval($sgmiwyygoukwoymc), 0, isset($aamyogyysuqgamuc->Message) ? $aamyogyysuqgamuc->Message : 'خطای نامشخص'); } } else { self::display_error(110003, '', strval($sgmiwyygoukwoymc), 0, isset($aamyogyysuqgamuc->Message) ? $aamyogyysuqgamuc->Message : 'خطای نامشخص'); } } return $sogksuscggsicmac; } public static function ewqamcaoimuwcquk($sgmiwyygoukwoymc, $ookmuoicsgkiciow, $mwksqkceimkqasii) { $eowgaqeqiwqauugi = curl_init(); curl_setopt_array($eowgaqeqiwqauugi, array(CURLOPT_URL => self::$base_url . '/api/payment/verify-transactions', CURLOPT_RETURNTRANSFER => true, CURLOPT_ENCODING => '', CURLOPT_MAXREDIRS => 10, CURLOPT_TIMEOUT => 0, CURLOPT_FOLLOWLOCATION => true, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1, CURLOPT_CUSTOMREQUEST => 'POST', CURLOPT_POSTFIELDS => '{
            "invoice": "' . $sgmiwyygoukwoymc . '",
            "urlId": "' . $ookmuoicsgkiciow . '"
            }
            ', CURLOPT_HTTPHEADER => array('Authorization: Bearer ' . $mwksqkceimkqasii, 'Content-Type: application/json'))); $keccaugmemegoimu = curl_exec($eowgaqeqiwqauugi); $sogksuscggsicmac = json_decode($keccaugmemegoimu); curl_close($eowgaqeqiwqauugi); return $sogksuscggsicmac; } public static function qqusuamsciuueuoo($sgmiwyygoukwoymc, $ookmuoicsgkiciow, $mwksqkceimkqasii) { $eowgaqeqiwqauugi = curl_init(); curl_setopt_array($eowgaqeqiwqauugi, array(CURLOPT_URL => self::$base_url . '/api/payment/reverse-transactions', CURLOPT_RETURNTRANSFER => true, CURLOPT_ENCODING => '', CURLOPT_MAXREDIRS => 10, CURLOPT_TIMEOUT => 0, CURLOPT_FOLLOWLOCATION => true, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1, CURLOPT_CUSTOMREQUEST => 'POST', CURLOPT_POSTFIELDS => '{"invoice":"' . $sgmiwyygoukwoymc . '","urlId": "' . urlId . '"}', CURLOPT_HTTPHEADER => array('Authorization: Bearer ' . $mwksqkceimkqasii, 'Content-Type: application/json'))); $keccaugmemegoimu = curl_exec($eowgaqeqiwqauugi); $sogksuscggsicmac = json_decode($keccaugmemegoimu); curl_close($eowgaqeqiwqauugi); return $sogksuscggsicmac; } public static function ycqoouqskcggsieu($ymacoouqwcqwwagu = '', $error_page = 0) { switch ($ymacoouqwcqwwagu) { case '1': $keccaugmemegoimu = 'ناموفق'; break; case '2': $keccaugmemegoimu = 'نامشخص'; break; case '401': $keccaugmemegoimu = 'مجاز به استفاده از سیستم نیستید.'; break; case '500': $keccaugmemegoimu = 'خطای داخلی سرور.'; break; case '13000': $keccaugmemegoimu = 'ورودی نامعتبر است.'; break; case '13001': $keccaugmemegoimu = 'آدرس نامعتبر است.'; break; case '13002': $keccaugmemegoimu = 'توکن نامعتبر است.'; break; case '13003': $keccaugmemegoimu = 'کد رهگیری یکتا نیست.'; break; case '13004': $keccaugmemegoimu = 'توکن خالی است.'; break; case '13005': $keccaugmemegoimu = 'عدم امکان دسترسی موقت به سرور.'; break; case '13007': $keccaugmemegoimu = 'کپچا منقضی شده است.'; break; case '13008': $keccaugmemegoimu = 'کپچا اشتباه است.'; break; case '13009': $keccaugmemegoimu = 'توکن منقضی شده است.'; break; case '13010': $keccaugmemegoimu = 'شماره موبایل نامعتبر است.'; break; case '13011': $keccaugmemegoimu = 'کد محصول نامعتبر است.'; break; case '13012': $keccaugmemegoimu = 'شناسه قبض نامعتبراست'; break; case '13013': $keccaugmemegoimu = 'شناسه پرداخت نامعتبراست'; break; case '13015': $keccaugmemegoimu = 'برای فراخوانی مجدد 2 دقیقه صبر کنید'; break; case '13016': $keccaugmemegoimu = 'تراکنش یافت نشد'; break; case '13017': $keccaugmemegoimu = 'طول ورودی نامعتبراست'; break; case '13018': $keccaugmemegoimu = 'یافت نشد'; break; case '13019': $keccaugmemegoimu = 'کد رهگیری برای کاربر لاگین شده در سیستم وجود ندارد'; break; case '13020': $keccaugmemegoimu = 'خطا هنگام چک کردن کد شرکت '; break; case '13021': $keccaugmemegoimu = 'پرداخت از پیش لغو شده است '; break; case '13022': $keccaugmemegoimu = 'تراکنش پرداخت نشده است '; break; case '13025': $keccaugmemegoimu = 'تراکنش ناموفق است '; break; case '13026': $keccaugmemegoimu = 'شماره کارت نامعتبراست'; break; case '13027': $keccaugmemegoimu = 'شماره موبایل برای شماره کارت وارد شده نیست'; break; case '13028': $keccaugmemegoimu = 'آدرس کالبک نامعتبراست'; break; case '13029': $keccaugmemegoimu = 'تراکنش موفق و تایید شده است'; break; case '13030': $keccaugmemegoimu = 'تراکنش تایید شده و ناموفق است '; break; case '13031': $keccaugmemegoimu = 'تراکنش منتظر تایید است'; break; case '13033': $keccaugmemegoimu = 'تراکنش و بازگشت تراکنش با موفقیت انجام شده است '; break; case '13035': $keccaugmemegoimu = 'تراکنش مجاز به انجام عملیات بازگشت نمی باشد'; break; case '130241': $keccaugmemegoimu = 'مبلغ شناسه پرداخت و مبلغ وروردی یکسان نیست '; break; case '130242': $keccaugmemegoimu = 'تراکنش با موفقیت برگشت داده شد'; break; case '130243': $keccaugmemegoimu = 'تراکنش تایید نشد و برگشت داده شد'; break; case '130244': $keccaugmemegoimu = 'تراکنش با مغایرت مواجه شد'; break; case '110001': $keccaugmemegoimu = 'این سفارش قبلا تکمیل شده است.'; break; case '110002': $keccaugmemegoimu = 'توکن دریافت نشد.'; break; case '110003': $keccaugmemegoimu = 'خطا در انتقال به صفحه پرداخت.'; break; case '13063': $keccaugmemegoimu = 'مبلغ کافی نیست.'; break; default: $keccaugmemegoimu = 'تراکنش انجام نشد'; break; } return $keccaugmemegoimu; } public static function qsguiaiyguwoqsms($sqeykgyoooqysmca, $eyagkkkqkwcuygso) { $post = "type={$sqeykgyoooqysmca}"; foreach ($eyagkkkqkwcuygso as $uusmaiomayssaecw => $eqgoocgaqwqcimie) { $post .= "&{$uusmaiomayssaecw}={$eqgoocgaqwqcimie}"; } $eowgaqeqiwqauugi = curl_init(); curl_setopt($eowgaqeqiwqauugi, CURLOPT_URL, 'https://pep.co.ir/dl/check_update/wordpress/index.php'); curl_setopt($eowgaqeqiwqauugi, CURLOPT_POSTFIELDS, $post); curl_setopt($eowgaqeqiwqauugi, CURLOPT_SSL_VERIFYPEER, false); curl_setopt($eowgaqeqiwqauugi, CURLOPT_RETURNTRANSFER, true); $sogksuscggsicmac = json_decode(curl_exec($eowgaqeqiwqauugi)); curl_close($eowgaqeqiwqauugi); return $sogksuscggsicmac; } public static function display_error($pay_status = '', $tran_id = '', $order_id = '', $is_callback = 1, $uamcoiueqaamsqma) { $page_title = ''; $page_html = '<div align="center" dir="rtl" style="font-family:tahoma;font-size:12px;line-height: 25px;color:#000000;margin: -25px 0px -23px 0px;">'; switch ($pay_status) { case 13022: $page_title = $admin_mess = 'پرداخت انجام نشد.'; $page_html .= '<span style="color:#ff0000;"><b>' . $admin_mess . '</b></span><br/>'; $page_html .= '<p style="margin-right:15px;font-size: 12px;margin: 15px 0px 20px 0px;line-height: 25px;">'; $page_html .= self::ycqoouqskcggsieu($pay_status); $page_html .= '</p>'; $page_html .= '<a href="' . get_option('siteurl') . '" style="text-decoration:none;">بازگشت به صفحه نخست >></a><br/>'; break; case 13029: $page_title = 'این تراکنش پیش از این موفق شده است'; $page_html .= '<span style="color:#008800;"><b>' . self::ycqoouqskcggsieu($pay_status) . '</b></span><br/>'; $page_html .= '<p style="margin-right:15px;font-size: 12px;margin: 15px 0px 20px 0px;line-height: 25px;">'; $page_html .= "تراکنش شما پیش از این با شماره پیگیری {$tran_id} با موفقیت ثبت شده است"; $page_html .= '</p>'; $page_html .= '<a href="' . get_option('siteurl') . '" style="text-decoration:none;">بازگشت به صفحه نخست >></a><br/>'; break; case 110001: $page_title = 'سفارش پیش از این موفق شده است'; $page_html .= '<span style="color:#008800;"><b>' . self::ycqoouqskcggsieu($pay_status) . '</b></span><br/>'; $page_html .= '<p style="margin-right:15px;font-size: 12px;margin: 15px 0px 20px 0px;line-height: 25px;">'; $page_html .= "این سفارش قبلا با موفقیت ثبت شده است"; $page_html .= '</p>'; $page_html .= '<a href="' . get_option('siteurl') . '" style="text-decoration:none;">بازگشت به صفحه نخست >></a><br/>'; break; case 110002: $page_title = $admin_mess = 'خطا در دریافت توکن'; $page_html .= '<span style="color:#ff0000;"><b>' . self::ycqoouqskcggsieu($pay_status) . '</b></span><br/>'; $page_html .= '<p style="margin-right:15px;font-size: 12px;margin: 15px 0px 20px 0px;line-height: 25px;">'; $page_html .= self::ycqoouqskcggsieu($pay_status); $page_html .= '</p>'; $page_html .= '<a href="' . get_option('siteurl') . '" style="text-decoration:none;">بازگشت به صفحه نخست >></a><br/>'; break; case 110003: $page_title = 'خطا در پرداخت '; $page_html .= '<span style="color:#ff0000;"><b> خطا در پرداخت </b></span><br/>'; $page_html .= '<p style="margin-right:15px;font-size: 12px;margin: 15px 0px 20px 0px;line-height: 25px;">'; $page_html .= self::ycqoouqskcggsieu($pay_status); $page_html .= '</p>'; $page_html .= '<a href="' . get_option('siteurl') . '" style="text-decoration:none;">بازگشت به صفحه نخست >></a><br/>'; break; case 13018: $page_title = 'خطا در پرداخت '; $page_html .= '<span style="color:#ff0000;"><b> خطا در پرداخت </b></span><br/>'; $page_html .= '<p style="margin-right:15px;font-size: 12px;margin: 15px 0px 20px 0px;line-height: 25px;">'; $page_html .= self::ycqoouqskcggsieu($pay_status); $page_html .= '</p>'; $page_html .= '<a href="' . get_option('siteurl') . '" style="text-decoration:none;">بازگشت به صفحه نخست >></a><br/>'; break; default: $page_title = 'خطا در پرداخت'; $page_html .= '<span style="color:#ff0000;"><b> خطا در پرداخت </b></span><br/>'; $page_html .= '<p style="margin-right:15px;font-size: 12px;margin: 15px 0px 20px 0px;line-height: 25px;">'; $page_html .= self::ycqoouqskcggsieu($pay_status); $page_html .= '</p>'; $page_html .= '<a href="' . get_option('siteurl') . '" style="text-decoration:none;">بازگشت به صفحه نخست >></a><br/>'; break; } $page_html .= '</div>'; if (isset($admin_mess) && $order_id != '' && $pay_status != 'order_not_for_this_person') { try { $umwqusowiqmyseom = new WC_Order(substr($order_id, 0, -2)); $umwqusowiqmyseom->add_order_note($admin_mess); } catch (Exception $iewosgggaueeyymg) { $umwqusowiqmyseom = new WC_Order($order_id); $umwqusowiqmyseom->add_order_note($admin_mess); } } if ($is_callback == 1) { wp_die($page_html, $page_title); } else { echo $page_html; } } public static function d_redirect($eeamcawaiqocomwy = '') { if ($eeamcawaiqocomwy != '') { if (headers_sent()) { echo '<script type="text/javascript">window.location.assign("' . $eeamcawaiqocomwy . '")</script>'; } else { header("Location: {$eeamcawaiqocomwy}"); } exit; } } public function process_payment($order_id) { $umwqusowiqmyseom = new WC_Order($order_id); return array('result' => 'success', 'redirect' => $umwqusowiqmyseom->get_checkout_payment_url(true)); } public static function oiicaeigckygieyy($ycskuuyucyuqisaq) { $sogksuscggsicmac = ""; for ($ciyackuwsqkoqese = 0; $ciyackuwsqkoqese < strlen($ycskuuyucyuqisaq); $ciyackuwsqkoqese++) { if (is_numeric($ycskuuyucyuqisaq[$ciyackuwsqkoqese])) { $sogksuscggsicmac .= $ycskuuyucyuqisaq[$ciyackuwsqkoqese]; } } return $sogksuscggsicmac; } public function receipt_page($order_id) { global $woocommerce; $umwqusowiqmyseom = new WC_Order($order_id); $wwigiesyquoeawog = $umwqusowiqmyseom->get_currency(); $smowyuyseuwiaiei = intval($umwqusowiqmyseom->get_total()); if (strtolower($wwigiesyquoeawog) == strtolower('IRT') || strtolower($wwigiesyquoeawog) == strtolower('TOMAN') || strtolower($wwigiesyquoeawog) == strtolower('Iran TOMAN') || strtolower($wwigiesyquoeawog) == strtolower('Iranian TOMAN') || strtolower($wwigiesyquoeawog) == strtolower('Iran-TOMAN') || strtolower($wwigiesyquoeawog) == strtolower('Iranian-TOMAN') || strtolower($wwigiesyquoeawog) == strtolower('Iran_TOMAN') || strtolower($wwigiesyquoeawog) == strtolower('Iranian_TOMAN') || strtolower($wwigiesyquoeawog) == strtolower('تومان') || strtolower($wwigiesyquoeawog) == strtolower('تومان ایران')) { $smowyuyseuwiaiei = $smowyuyseuwiaiei * 10; } else { if (strtolower($wwigiesyquoeawog) == strtolower('IRHT')) { $smowyuyseuwiaiei = $smowyuyseuwiaiei * 1000 * 10; } else { if (strtolower($wwigiesyquoeawog) == strtolower('IRHR')) { $smowyuyseuwiaiei = $smowyuyseuwiaiei * 1000; } } } $eqkwygommoygskea = self::oiicaeigckygieyy($this->pasargad_terminal_id); $jaemqqwquuiaswww = $this->pasargad_merchant_id; $iwsgyqmaqukgemus = $this->redirect_uri . "?order_id=" . $order_id; $order_id = $order_id . mt_rand(10, 99); $aamyogyysuqgamuc = self::qaiewqumaqycgomm($order_id, $eqkwygommoygskea, $jaemqqwquuiaswww, $smowyuyseuwiaiei, $iwsgyqmaqukgemus); if (isset($aamyogyysuqgamuc) && $aamyogyysuqgamuc->resultCode == 0) { self::d_redirect('https://pep.shaparak.ir/payment.aspx?n=' . $aamyogyysuqgamuc->Token); } else { self::display_error($aamyogyysuqgamuc->resultCode, '', $order_id, 0, isset($aamyogyysuqgamuc->Message) ? $aamyogyysuqgamuc->Message : 'خطای نامشخص'); } return false; } public static function swieyekscicyigcg() { $ceaqswckgymsswqk = self::$username_p; $wmsqwokmgiusoswc = self::$password_p; $icwicymcioeyeyek = array('username' => $ceaqswckgymsswqk, 'password' => $wmsqwokmgiusoswc); $eowgaqeqiwqauugi = curl_init(self::$base_url . '/token/getToken'); curl_setopt($eowgaqeqiwqauugi, CURLOPT_POST, 1); curl_setopt($eowgaqeqiwqauugi, CURLOPT_POSTFIELDS, json_encode($icwicymcioeyeyek)); curl_setopt($eowgaqeqiwqauugi, CURLOPT_RETURNTRANSFER, true); curl_setopt($eowgaqeqiwqauugi, CURLOPT_HTTPHEADER, array('Content-Type: application/json')); $piuesceqiguuskme = curl_exec($eowgaqeqiwqauugi); $sogksuscggsicmac = json_decode($piuesceqiguuskme); curl_close($eowgaqeqiwqauugi); if (!isset($sogksuscggsicmac) || !isset($sogksuscggsicmac->token)) { self::display_error(110002, '', '', 1, 'خطای در دریافت توکن'); exit; } elseif (isset($sogksuscggsicmac->resultCode) && $sogksuscggsicmac->resultCode != 0) { self::display_error(isset($sogksuscggsicmac->resultCode) ? $sogksuscggsicmac->resultCode : null, '', '', 0, self::ycqoouqskcggsieu($sogksuscggsicmac->resultCode)); exit; } return $sogksuscggsicmac; } public function sccieggaoaawaiww($qcgeuycgswcuiquo) { $uwscwwouoesqwwue = isset(self::swieyekscicyigcg()->token) ? self::swieyekscicyigcg()->token : ''; $error_code = isset($uwscwwouoesqwwue) ? null : 'توکن نامعتبر است'; $umyeqaqmiggusquc = ''; if (isset($error_code)) { self::display_error(isset($error_code) ? $error_code : null, $umyeqaqmiggusquc, $gikswyewyiiausaq, 1, isset($uamcoiueqaamsqma) ? $uamcoiueqaamsqma : ''); exit; } $eowgaqeqiwqauugi = curl_init(); curl_setopt_array($eowgaqeqiwqauugi, array(CURLOPT_URL => self::$base_url . '/api/payment/payment-inquiry', CURLOPT_RETURNTRANSFER => true, CURLOPT_ENCODING => '', CURLOPT_MAXREDIRS => 10, CURLOPT_TIMEOUT => 0, CURLOPT_FOLLOWLOCATION => true, CURLOPT_HTTP_VERSION => CURL_HTTP_VERSION_1_1, CURLOPT_CUSTOMREQUEST => 'POST', CURLOPT_POSTFIELDS => '{
                  "invoiceId": "' . $qcgeuycgswcuiquo . '"
              }', CURLOPT_HTTPHEADER => array('Authorization: Bearer ' . self::swieyekscicyigcg()->token, 'Content-Type: application/json', 'Referer: ' . untrailingslashit(home_url())))); $keccaugmemegoimu = curl_exec($eowgaqeqiwqauugi); curl_close($eowgaqeqiwqauugi); return $keccaugmemegoimu; } public function ekiuyucoiagmscgy() { global $woocommerce; $order_id = isset($_GET['order_id']) ? $_GET['order_id'] : ''; $qcgeuycgswcuiquo = isset($_GET['invoiceId']) ? $_GET['invoiceId'] : ''; $sgmiwyygoukwoymc = isset($qcgeuycgswcuiquo) ? $qcgeuycgswcuiquo : ''; $sgmiwyygoukwoymc = self::oiicaeigckygieyy($sgmiwyygoukwoymc); $order_id = self::oiicaeigckygieyy($order_id); $yuouccewiokccisa = isset($_REQUEST['iD']) ? $_REQUEST['iD'] : ''; $eqkwygommoygskea = self::oiicaeigckygieyy($this->pasargad_terminal_id); $jaemqqwquuiaswww = $this->pasargad_merchant_id; $umyeqaqmiggusquc = ""; if ($order_id == substr($sgmiwyygoukwoymc, 0, -2)) { $umwqusowiqmyseom = new WC_Order($order_id); $is_finish_ord = $this->is_finish_order; $new_state = 'processing'; if ($is_finish_ord != 'no') { $new_state = 'completed'; } if (isset($umwqusowiqmyseom->id)) { if ($umwqusowiqmyseom->get_status() == 'wc-completed') { $error_code = '110001'; } else { if ($qcgeuycgswcuiquo != '') { $skecwywmcgyawemu = self::sccieggaoaawaiww($qcgeuycgswcuiquo); $skecwywmcgyawemu = json_decode($skecwywmcgyawemu); } else { $skecwywmcgyawemu = null; } if (isset($skecwywmcgyawemu->resultCode) && isset($skecwywmcgyawemu) && ($skecwywmcgyawemu->resultCode == 0 || $skecwywmcgyawemu->resultCode == 13031)) { $icwicymcioeyeyek = $skecwywmcgyawemu->data; $eeamcawaiqocomwy = $icwicymcioeyeyek->url; $umyeqaqmiggusquc = $icwicymcioeyeyek->referenceNumber; $aamyogyysuqgamuc = self::ewqamcaoimuwcquk($sgmiwyygoukwoymc, $eeamcawaiqocomwy, self::swieyekscicyigcg()->token); if (isset($aamyogyysuqgamuc) && ($aamyogyysuqgamuc->resultCode == 0 || $aamyogyysuqgamuc->resultCode == 13029)) { $is_finish_ord = $this->is_finish_order; $new_state = 'processing'; if ($this->is_finish_order == 'yes') { $new_state = 'completed'; } if ($umwqusowiqmyseom->update_status($new_state)) { $umwqusowiqmyseom->payment_complete(); $umwqusowiqmyseom->add_order_note('پرداخت شما با موفقیت با شماره پیگیری ' . $umyeqaqmiggusquc . ' انجام شد.', 1); $woocommerce->cart->empty_cart(); wp_redirect($this->get_return_url($umwqusowiqmyseom)); exit; } else { $reversal_request = self::qqusuamsciuueuoo($sgmiwyygoukwoymc, $eeamcawaiqocomwy, self::swieyekscicyigcg()->token); if (isset($reversal_request) && $reversal_request->IsSuccess) { $error_code = 'reversal_done'; } else { $error_code = 'reversal_error'; } } } else { $uamcoiueqaamsqma = $skecwywmcgyawemu->resultMsg; $error_code = $skecwywmcgyawemu->resultCode; } } else { $error_code = $skecwywmcgyawemu->resultCode; } } } else { $error_code = 'order_not_exist'; } } else { $error_code = 'order_not_for_this_person'; } self::display_error(isset($error_code) ? $error_code : null, $umyeqaqmiggusquc, $order_id, 1, isset($uamcoiueqaamsqma) ? $uamcoiueqaamsqma : ''); exit; } public static function pep_wpwc_plugin_action_links($aiwcguiecocoyqqi, $qogsmwakwacwqogk) { static $this_plugin; if (false === isset($this_plugin) || true === empty($this_plugin)) { $this_plugin = plugin_basename(__FILE__); } if ($qogsmwakwacwqogk == $this_plugin) { $settings_link = '<a href="' . admin_url('admin.php?page=wc-settings&tab=checkout&section=pasargad') . '">تنظیمات</a>'; array_unshift($aiwcguiecocoyqqi, $settings_link); } return $aiwcguiecocoyqqi; } } function woocommerce_add_pasargad_gateway_method($msasmemeuceeaska) { $msasmemeuceeaska[] = 'WC_Pasargad_Gateway'; return $msasmemeuceeaska; } add_filter('woocommerce_payment_gateways', 'woocommerce_add_pasargad_gateway_method'); } add_action('plugins_loaded', 'woocommerce_pasargad_payment_init', 0);
